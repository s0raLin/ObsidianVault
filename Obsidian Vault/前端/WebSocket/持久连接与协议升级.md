持久连接也被称为 **HTTP keep-alive** 或 **HTTP 连接复用**

它是一条始终保持打开的 HTTP 连接，可以发送多个请求并接收多个响应

**HTTP 1.1** 允许在同一连接上处理多个请求和响应，需要在请求中添加额外的请求头：
```pgsql
Connection: keep-alive
```
当客户端或服务器发送以下头部时，连接才会关闭：
```pgsql
Connection: close
```
从 **HTTP 1.1** 开始，默认所有连接都是持久连接，除非特别声明关闭

### 持久连接的优势

与每次请求后都关闭的连接相比，持久连接具有很多优点：
- 请求服务器的延迟更低，因为不需要每次重新建立连接
- 可以同时发送或接收多个请求和响应
- 即使出现错误，连接也不会立即关闭，提高稳定性


## 协议升级（Protocol upgrading）

HTTP 1.1（及以上版本）还支持在持久连接上进行**协议升级**。  
它可以将 HTTP 连接升级为：

- HTTP 2.0
- WebSocket

当浏览器或服务器只支持特定协议，或者需要 WebSocket 连接时，这种方式非常有用。

需要设置以下请求头：
```makefile
Connection: upgrade
Upgrade: protocol/version
```
可以列出多个协议，用逗号分隔。  
协议版本是可选的

**升级为 HTTP 2.0**
```js
Connection: upgrade
Upgrade: HTTP/2.0
```

**升级为 WebSocket**
```js
Connection: upgrade
Upgrade: websocket
```

## 持久连接的类型
建立持久连接有很多方法，这里介绍最常见的三种：
1. **Long Polling（长轮询）**
2. **Server-Sent Events（SSE，服务器发送事件）**
3. **WebSockets**

每种方式都有不同的特点，适用于不同场景

### Long Polling（长轮询）

这是最早也是最简单的实现方式。  
浏览器建立一个 HTTP 连接，并长时间保持打开，让服务器可以随时发送响应，而无需重新建立连接。


### Server-Sent Events（SSE）

SSE 基于 HTTP 协议，允许服务器自动向浏览器推送更新。  
服务器发送数据后，网页内容可以异步更新。

特点：
- 实现简单
- 除 Internet Explorer 外几乎所有浏览器都支持
- 适合需要持久连接的小型应用

### WebSockets

这是最常用的持久连接技术之一。

WebSocket 是：

- 基于 TCP 的**独立协议**
- 不像 Long Polling 和 SSE 那样基于 HTTP

它可以实现浏览器与网站之间更紧密的交互，非常适合实时应用。

优点：

- 协议轻量
- 浏览器最多支持约 1024 个并行连接
- 性能优于 Long Polling 和 SSE

WebSocket 有自己的 URI 方案：

- `ws://` 不安全连接
- `wss://` 安全连接

建议始终使用：
```js
wss://
```

这样可以保证数据安全和应用可靠。

---

### WebSocket 的应用场景

由于速度快、功能强、安全性高，WebSocket 被广泛使用，例如：

- 电商网站
- 社交网络
- 多人在线游戏
- 实时应用